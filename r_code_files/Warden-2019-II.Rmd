---
title: "Warden and Gore waterbird analyses"
author: "Adrian Pinder"
date and time: '`r Sys.time()`'
output: html_document
software: 'RStudio: Version 1.1.463 – © 2009-2018 RStudio, Inc. R version: `r getRversion()`'
editor_options: 
  chunk_output_type: console
---
  
Git repository https://github.com/AdrianMP62/Warden-2019  

RStudio: Version 1.1.463 – © 2009-2018 RStudio, Inc. R version: `r getRversion()`  
Date and time: `r Sys.time()`

Uses the following datafiles:  
*  Warden_Gore_by_suite_06_19.csv (System,	SurveyType,	SiteName,	SiteCode,	Subsite	Date,	CommonName,	SpeciesCode,	Count) (e.g. Warden,	aerial,	Neridup Suite,	WRP001,	combined,	11/10/2006,	Great Egret,	greg,	1)
*  Average depths.csv (average depths of Warden wetlands for each survey period).
*  Taxonomy (CommonName, Order and informal group name in consecutive columns. CommonNames match those in rden_Gore_by_suite_06_19.csv)

Date and time: `r Sys.time()`

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_knit$set(root.dir = '../') 
```

```{r}
options(scipen=999)
```

```{r set-seed}
set.seed(1234)
```

```{r load-packages, results="hide", warning=FALSE, message=FALSE}
Packages <- c("vegan", "ggrepel", "grid", "ggplot2", "scales","lubridate", "stringr", "gsubfn", "reshape2", "knitr", "simba", "zoo", "car")
lapply(Packages, library, character.only = TRUE)
source("./functions/bio_env_ext.R") #The Bio_env and bv_step_ext routines below comes from http://menugget.blogspot.com.au/2011/06/clarke-and-ainsworths-bioenv-and-bvstep.html
source("./functions/bv_step_ext.R")
source("./functions/bv.step.R")
```

#Analyses of waterbird data from the Warden and Gore Ramsar wetlands 2006 to 2019
  
The following is the output from an Rmarkdown R script for analyses of waterbird communities of the Warden and Gore wetland systems surveyed between Oct 2006 and Feb 2019.  
  
These analyses are based primarily on ground counts. Aerial counts are only for a few Warden system wetlands in 2006 to 2009 where ground counts were not undertaken. These include Neridup and Bandy Creek (Oct 2006-Nov 2008), Ewans (Oct 2006) and Ewans and Mullet combined (Nov 2008 - have to ignore Nov 2008 Mullet ground counts), North Wheatfield (Oct 2006, Oct 2007, Nov 2008). Note that the Nov 2008 aerial data was collected two weeks prior to the ground counts.  Gore data is included only for November 2009 onwards when ground counts are available. Pink Lake is excluded from analyses because it wasnt consistently surveyed. Birds counted only while in air and not allocated to any particular wetland are given the site code 'In flight'. These conditions apply to all following analyses.  
  
##Multi-variate analysis of Warden and Gore combined waterbird data by season  

This ordination shows that, by and large, with data from systems (Warden and Gore) combined, there is a difference between waterbird communities present in spring and those present in late summer.

```{r import-and-restructure-Warden-and-Gore-waterbird-data}
input.data <- read.csv("./raw_data/Warden_Gore_by_suite_06_19.csv")
 WG.bySeason <- input.data
  WG.bySeason <- WG.bySeason[-grep("Unidentified", WG.bySeason$CommonName), ] #remove rows where birds not identified
  WG.bySeason <- WG.bySeason[-grep("Grassbird", WG.bySeason$CommonName), ] #remove records of little grassbird
  WG.bySeason <- WG.bySeason[!(WG.bySeason$Date == "23/02/2010" & WG.bySeason$SiteCode == "WRP004"), ] #remove duplicate data for Mullet Feb 2010
  WG.bySeason$Date <- as.Date(WG.bySeason$Date, format="%d/%m/%Y")
  WG.bySeason$Survey <- WG.bySeason$Date #create Survey field from Date
  WG.bySeason$Survey <- format(as.Date(WG.bySeason$Survey), "%b-%Y") #change format to mmm-YYYY
  WG.bySeason$Survey <- gsub("Oct-2018", "Nov-2018", WG.bySeason$Survey) #lump survey dates that straddle Oct/Nov 2018
  yq <- as.yearqtr(as.yearmon(WG.bySeason$Date, "%Y/%m/%d"))
WG.bySeason$Season <- factor(format(yq, "%q"), levels = 1:4, labels = c("summer", "autumn", "winter", "spring")) #create Season (spring vs summer) variable
write.csv(WG.bySeason, "./analysis_data/WG.bySeason.csv")
```

```{r aggregare-by-survey-and-species}
  WG.bySeason.agg <- aggregate(data=WG.bySeason, Count ~ CommonName + Survey + Season, FUN="sum") #sum data by common name and survey period
```

```{r create-matrix-for-ordination}
  WG.bySeason.agg <- melt(WG.bySeason.agg) #melt data 
  WG.bySeason.m <- dcast(WG.bySeason.agg, Survey ~ CommonName, fill="0") #create matrix from flat-file
  rownames(WG.bySeason.m) <- WG.bySeason.m [,1] #use first column (season) as row.names
  WG.bySeason.m [,1] <- NULL #remove season column
  WG.bySeason.m <- data.matrix(WG.bySeason.m, rownames.force = NA) #convert data to numeric format (required for metaMDS)
```

```{r undertake-2D-and-3D_ordination}
WG.MDS.bySeas <- metaMDS(WG.bySeason.m, distance = "bray")
WG.3dMDS.bySeas <- metaMDS(WG.bySeason.m, distance = "bray", k=3)
```

```{r extract-list-of-seasons-for-ordination-plots}
surv.seas<- unique(WG.bySeason[c("Survey", "Season")]) #extract a unique list of survey codes (mmm-yy) and season so can later allocate a season to each survey in the MDS output
surv.seas <- surv.seas[order(surv.seas$Survey), ] #reorder alphabetically by Survey (Dec-2011 to Oct-2012)
```
  
```{r create-2D-dataset-for-plotting}
  WG.MDS.bySeas.pts <- as.data.frame(WG.MDS.bySeas$points) #extract 2D ordination coordinates (points)
  WG.MDS.bySeas.pts$Survey <- row.names(WG.MDS.bySeas.pts) #use survey period as row.names
  WG.MDS.bySeas.pts$Season <- surv.seas[match(WG.MDS.bySeas.pts$Survey, surv.seas$Survey), 2] #adds 'season' (spring versus summer) (from column '2' of Surv.Seas) to ordination points by matching survey between points and surv.seas
```

```{r create-3D-dataset-for-plotting}
  WG.3dMDS.bySeas.pts <- as.data.frame(WG.3dMDS.bySeas$points) #extract 3D ordination coordinates (points)
  WG.3dMDS.bySeas.pts$Survey <- row.names(WG.3dMDS.bySeas.pts) #use survey period as row.names
  WG.3dMDS.bySeas.pts$Season <- surv.seas[match(WG.3dMDS.bySeas.pts$Survey, surv.seas$Survey), 2] #adds 'season' (spring versus summer) (from column '2' of Surv.Seas) to ordination points by matching survey between points and surv.seas
```
 
2D ordination plot of Warden and Gore data combined by season, stress = `r WG.MDS.bySeas$stress`.
```{r, 2D-ordination-plot-by-season, include=TRUE}
ggplot(WG.MDS.bySeas.pts, aes(x=MDS1, y=MDS2)) + xlim(-0.4, 0.35) + ylim(-0.3, 0.2) + geom_point(aes(colour=Season), size=5) + coord_fixed(ratio = 1) + geom_text(aes(label=Survey), size=3, vjust=1, hjust=1.3)
```

3D ordination plot of Warden and Gore data combined by season, stress = `r WG.MDS.bySeas$stress`.
```{r, 3D-ordination-plot-by-season, include=TRUE}
ggplot(WG.3dMDS.bySeas.pts, aes(x=MDS1, y=MDS2)) + xlim(-0.4, 0.35) + ylim(-0.3, 0.3) + geom_point(aes(colour=Season, shape=System), size=5) + coord_fixed(ratio = 1) + geom_text(aes(label=Survey), size=3, vjust=1, hjust=1.3) + theme (plot.margin=unit(c(0,0,0,5),"mm"))
```

```{r run-simper-analysis-to-determine-influence-of-species-by-season}
  WG.bySeas.Simper <- simper(WG.bySeason.m, surv.seas$Season) #Simper analysis to determine which species best correlated with differences between seasons of whole dataset
```

```{r extract-top-8-spp-from-simper-to-contrast-seasons}
  WG.Simper.ext <- WG.bySeas.Simper$spring_summer #extract results from Simper analysis
  WG.Sim.Average <- as.data.frame(WG.Simper.ext$average) #extract the average difference data
  WG.Sim.Spec <- as.data.frame(WG.Simper.ext$species) #extract species names
  WG.bySeas.Simper2 <- cbind(WG.Sim.Spec, WG.Sim.Average) #combine species with averages
  WG.bySeas.Simper2 <- WG.bySeas.Simper2[ order(-WG.bySeas.Simper2[, 2]), ] #order species and averages by average
colnames(WG.bySeas.Simper2) = c("Species", "cont") #add new column names
  WG.bySeas.Simper2 <- as.vector(WG.bySeas.Simper2[1:8, 1]) #extracts 
```

```{r aggregate-by-sppname-and-survey-for season-simper}
  agg.spec.data <- aggregate(data=WG.bySeason, Count ~ CommonName + Season + Survey, FUN="sum") #aggregate counts by common name, season and survey
  #agg.spec.data <- as.data.frame(sapply(agg.spec.data, gsub, pattern = "-", replacement = " ")) #replace dashes with spaces
```

```{r extract-counts-of-top-8-species-from-simper-for-contrasting-system}
  agg.spec.data.8 <- agg.spec.data[agg.spec.data$CommonName %in% WG.bySeas.Simper2, ]
  rownames(agg.spec.data.8) <- NULL #reset row names
  agg.spec.data.8 <- as.data.frame(agg.spec.data.8[, -3]) #remove Survey field
  agg.spec.data.8$CommonName <- as.character(agg.spec.data.8$CommonName)
```

```{r write-then-read-top-8-species-data-to-convert-to-numeric-for-analysis-by-season}
  write.csv(agg.spec.data.8, "agg.spec.data.8.csv")
  agg.spec.data.8 <- read.csv("agg.spec.data.8.csv")
```

These box plots show the abundance of the top 8 species contributiong to waterbird communities being different in spring and summer (Gore and Warden systems combined).  
```{r simper-by-season-box-plots, include=TRUE}
  qplot(x=Season, y=Count, data=agg.spec.data.8, geom="boxplot") + facet_wrap(~ CommonName, scales="free_y", ncol=2)
```


##ORDINATION OF GORE SYSTEM VERSUS WARDEN SYSTEM  

The ordination plot below shows that the Warden and Gore wetland systems consistently support different waterbird communities, i.e. for waterbirds they have different conservation values. It can also be seen that there is greater seasonal differences in the Warden system than in the Gore system (i.e. greater overlap between positions of the summer and spring surveys amongst the Gore surveys).  

the Nov 2018 and Feb 2019 surveys are within the range of community compositions surveyed since 2006 for both systems, despite the very high counts in Feb 2019 and low Warden count in Nov 2018.

```{r import-reduce-aggregate-data}
 input.data2 <- read.csv("./raw_data/Warden_Gore_by_suite_06_19.csv")
  WG.bySystem <- input.data2
    WG.bySystem <- WG.bySystem[-grep("Unidentified", WG.bySystem$CommonName), ] #remove rows where birds not identified
  WG.bySystem <- WG.bySystem[-grep("Grassbird", WG.bySystem$CommonName), ] #remove records of little grassbird
  WG.bySystem <- WG.bySystem[!(WG.bySystem$Date == "23/02/2010" & WG.bySystem$SiteCode == "WRP004"), ] #remove duplicate data for Mullet Feb 2010
  WG.bySystem$Date <- as.Date(WG.bySystem$Date, format="%d/%m/%Y")
  WG.bySystem$Survey <- WG.bySystem$Date #create Survey field from Date
  WG.bySystem$Survey <- format(as.Date(WG.bySystem$Survey), "%b-%Y") #change format to mmm-YYYY
  WG.bySystem$Survey <- gsub("Oct-2018", "Nov-2018", WG.bySystem$Survey) #lump survey dates that straddle Oct/Nov 2018
  yq <- as.yearqtr(as.yearmon(WG.bySystem$Date, "%Y/%m/%d"))
WG.bySystem$Season <- factor(format(yq, "%q"), levels = 1:4, labels = c("summer", "autumn", "winter", "spring")) #create Season (spring vs summer) variable
  WG.bySystem$Sys_Sur <- paste(WG.bySystem$System, WG.bySystem$Survey, sep = " ") # combine System and date to create one 'sample' variable for mds - i.e. combine system with season
write.csv(WG.bySystem, "./WG.bySystem.csv")
```

```{r aggregate-by-Common-Name}
WG.bySystem.agg <- aggregate(data=WG.bySystem, Count ~ CommonName + Sys_Sur, FUN="sum")
```

```{r create_matrix_for_ordaniation}
  WG.bySystem.agg <- melt(WG.bySystem.agg) #melt data
  WG.bySystem.m <- dcast(WG.bySystem.agg, Sys_Sur ~ CommonName, fill="0") #recast as matrix
rownames(WG.bySystem.m) <- WG.bySystem.m[,1]
  WG.bySystem.m[,1] <- NULL
  WG.bySystem.m <- data.matrix(WG.bySystem.m, rownames.force = NA) #convert data to numeric format (required for metaMDS)
```

MDS unconstrained ordination using metaMDS in package vegan to compare Warden and Gore wetland systems
```{r ordination-by-system}
WG.MDS.bySyst <- metaMDS(WG.bySystem.m, distance = "bray")
```

```{r extract-coordinates-from-nMDS-and-add-season-to-resulting-data.frame-for-Warden-versus-Gore-analysis}
system <- unique(input.data2$System) #extract a unique list of systems (Gore, Warden)
WG.MDS.bySyst.pts <- as.data.frame(WG.MDS.bySyst$points) #extract coordinates from metaMDS
WG.MDS.bySyst.pts$Sys_Sur <- row.names(WG.MDS.bySyst.pts) #use row.names to create new System+Survey period variable
WG.MDS.bySyst.pts$Survey <- str_sub(WG.MDS.bySyst.pts$Sys_Sur, -8, -1) #extract Survey period from Sys-Sur variable by extracting last 8 characters
WG.MDS.bySyst.pts$System <- substr(WG.MDS.bySyst.pts$Sys_Sur, 1, 4) #extract System from Sur-sys variable by extracting first 4 variables
WG.MDS.bySyst.pts$System <- gsub("Ward", "Warden", WG.MDS.bySyst.pts$System) #convert 'Ward' to 'Warden'
#WG.MDS.bySyst.pts <- WG.MDS.bySyst.pts[with(WG.MDS.bySyst.pts, order(Survey)), ] #order by survey
WG.MDS.bySyst.pts$Season <-  substr(WG.MDS.bySyst.pts$Survey, 1, 3) #extract months
WG.MDS.bySyst.pts$Season <- recode(WG.MDS.bySyst.pts$Season, "'Feb'='summer';c('Dec','Oct','Nov')='spring'") #convert months to season
WG.MDS.bySyst.pts$SystSeas <- paste(WG.MDS.bySyst.pts$System, WG.MDS.bySyst.pts$Season, sep=" in ")
str(WG.MDS.bySyst.pts) #join System and season
```

ordination plot with symbols coloured by system (Warden versus Gore), `r WG.MDS.bySyst$stress`
```{r plot-2D-ordination-by-system, include=TRUE}
ggplot(WG.MDS.bySyst.pts, aes(x=MDS1, y=MDS2, shape=SystSeas, colour=SystSeas)) + xlim(-0.5, 0.35) + ylim(-0.35, 0.3) + coord_fixed(ratio = 1) + geom_point(size=5) + scale_color_manual(values=c("blue","blue","red","red")) + scale_shape_manual(values=c(0,15,2,17)) + geom_text(aes(label=Survey), colour="black", size=3, vjust=1, hjust=1.3)
```

However, the stress level of the above two-dimensional ordintion is unacceptably high at `r WG.MDS.bySyst$stress`. A three-dimensional ordination was therefore undertaken.

3D MDS unconstrained ordination using metaMDS in package vegan to compare Warden and Gore wetland systems
```{r 3Dordination-by-system}
WG.3dMDS.bySyst <- metaMDS(WG.bySystem.m, distance = "bray", k=3, transform="false")
plot(WG.3dMDS.bySyst, xlim=c(-1,1), display = c("sites", "species"), type="t")
```

```{r extract-coordinates-from-3D-nMDS-and-add-season-to-resulting-data.frame-for Warden-versus-Gore-analysis}
system <- unique(input.data2$System) #extract a unique list of systems (Gore, Warden)
WG.3dMDS.bySyst.pts <- as.data.frame(WG.3dMDS.bySyst$points) #extract coordinates from metaMDS
WG.3dMDS.bySyst.pts$Sys_Sur <- row.names(WG.3dMDS.bySyst.pts) #use row.names to create new System+Survey period variable
WG.3dMDS.bySyst.pts$Survey <- str_sub(WG.3dMDS.bySyst.pts$Sys_Sur, -8, -1) #extract Survey period from Sys-Sur variable by extracting last 8 characters
WG.3dMDS.bySyst.pts$System <- substr(WG.3dMDS.bySyst.pts$Sys_Sur, 1, 4) #extract System from Sur-sys variable by extracting first 4 variables
WG.3dMDS.bySyst.pts$System <- gsub("Ward", "Warden", WG.3dMDS.bySyst.pts$System) #convert 'Ward' to 'Warden'
#WG.3dMDS.bySyst.pts <- WG.3dMDS.bySyst.pts[with(WG.3dMDS.bySyst.pts, order(Survey)), ] #order by survey
WG.3dMDS.bySyst.pts$Season <-  substr(WG.3dMDS.bySyst.pts$Survey, 1, 3) #extract months
WG.3dMDS.bySyst.pts$Season <- recode(WG.3dMDS.bySyst.pts$Season, "'Feb'='summer';c('Dec','Oct','Nov')='spring'") #convert months to season
WG.3dMDS.bySyst.pts$SystSeas <- paste(WG.3dMDS.bySyst.pts$System, WG.3dMDS.bySyst.pts$Season, sep=" in ")
str(WG.3dMDS.bySyst.pts) #join System and season
```

```{r plot-3D-ordination-by-system, include=TRUE}
ggplot(WG.3dMDS.bySyst.pts, aes(x=MDS1, y=MDS2, shape=SystSeas, colour=SystSeas)) + xlim(-0.5, 0.4) + ylim(-0.3, 0.3) + coord_fixed(ratio = 1) + geom_point(size=5) + scale_color_manual(values=c("blue","blue","red","red")) + scale_shape_manual(values=c(0,15,2,17)) + theme(legend.title = element_blank()) + theme(legend.position = "top") + theme(legend.text=element_text(size=12)) + theme(plot.margin=unit(c(0,0,0,0),"mm")) + geom_text_repel(aes(label=Survey), colour="grey", size=5, vjust=1, hjust=1.5)
```

```{r simper-analysis-of-species-separating-the-two-systems}
  WG.bySyst.Sim <- simper(WG.bySystem.m, WG.3dMDS.bySyst.pts$System) #Simper analysis to determine which species best correlated with differences between seasons of whole dataset
summary(WG.bySyst.Sim, ordered=TRUE)
```

```{r extract-simperdata-for-top10pp}
  WG.bySyst.Sim.ext <- WG.bySyst.Sim$Gore_Warden #extract name and contribution data from simper analysis
  WG.bySyst.Sim.average <- as.data.frame(WG.bySyst.Sim.ext$average)#extract average contribution values
  WG.bySyst.Sim.spec <- as.data.frame(WG.bySyst.Sim.ext$species)#extract species names
  WG.bySyst.Sim.ext <- cbind(WG.bySyst.Sim.spec, WG.bySyst.Sim.average) #combine average with species name
  WG.bySyst.Sim.ext <- WG.bySyst.Sim.ext[ order(-WG.bySyst.Sim.ext[,2]), ] #order by average value
colnames(WG.bySyst.Sim.ext) = c("Species", "cont") #add new column names
  WG.bySyst.Sim.ext <- as.vector(WG.bySyst.Sim.ext[1:10, 1]) #extract top eight species: first 8 rows
  #WG.bySyst.Sim.ext <- gsub("\\.", " ", WG.bySyst.Sim.ext)
```

```{r restrict-countdata-to-simper-top10spp}
WG.bySystem$Count2 <- WG.bySystem$Count^2
agg.spec.data.2 <- aggregate(data=WG.bySystem, Count2 ~ CommonName + Survey + System, FUN="sum") #aggregare count data by system and survey
#agg.spec.data.2 <- as.data.frame(sapply(agg.spec.data.2, gsub, pattern = "-", replacement = " ")) #replace dashes in species names with spaces to match simper output
agg.spec.data.2 <- agg.spec.data.2[agg.spec.data.2$CommonName %in% WG.bySyst.Sim.ext, ] #restrict aggregated counts to just those top 8 species from simper
rownames(agg.spec.data.2) <- NULL
agg.spec.data.2$CommonName <- as.character(agg.spec.data.2$CommonName)
colnames(agg.spec.data.2)[4] <- "Abundance"
write.csv(agg.spec.data.2, "agg.spec.data.2.csv")
agg.spec.data.2 <- read.csv("agg.spec.data.2.csv")
```

A simper analysis was undertaken to determine which species were most responsible for the separation of Warden and Gore wetland systems. For the top ten species, box plots of abundance on the Warden versus Gore systems are provided below.  

```{r boxplots-simper-top10spp, include=TRUE}
qplot(x=System, y=Abundance, data=agg.spec.data.2, geom="boxplot") + facet_wrap(~ CommonName, scales="free_y", ncol=2) + theme(axis.title.y = element_text(hjust=0.5)) #produce facet wrapped box plots showing differences in top 10 simper species by wetland system
```

undertake Mann-Whitney for each of the 10 top Simper species and combine results into file called ttest.results<p/>
```{r}
WG.bySyst.Sim.ext <- WG.bySyst.Sim.ext[-8]
WG.bySyst.Sim.ext
ttest.v <- vector()
for (i in 1:9) {
tt.data <- subset(agg.spec.data.2, CommonName == WG.bySyst.Sim.ext[i])
print(ttest <- wilcox.test(log10(Abundance) ~ System, data = tt.data))
ttest.v <- c(ttest.v, ttest$p.value)
}
ttest.v
ttest.results <- data.frame(CommonName=WG.bySyst.Sim.ext, p.value=ttest.v)
ttest.results
```


##WARDEN SYSTEM ANALYSIS ONLY  

###Ordinations and associated analyses

####Input waterbird data and split into spring and summer datasets, including creating a survey variable
```{r input_data_and_prepare_for_just_Warden_ordinations}
input.data3 <- read.csv("./raw_data/Warden_Gore_by_suite_06_19.csv")
Warden <- input.data3
Warden <- Warden[-grep("Unidentified", Warden$CommonName), ] #remove rows where birds not identified
Warden <- Warden[Warden$System=="Warden", ] #cut down to just Warden wetlands
Warden <- Warden[-grep("Grassbird", Warden$CommonName), ] #remove records of little grassbird
  Warden <- Warden[!(Warden$Date == "23/02/2010" & Warden$SiteCode == "WRP004"), ] #remove duplicate data for Mullet Feb 2010
  Warden$Date <- as.Date(Warden$Date, format="%d/%m/%Y")
  Warden$Survey <- Warden$Date #create Survey field from Date
  Warden$Survey <- format(as.Date(Warden$Survey), "%b-%Y") #change format to mmm-YYYY
  Warden$Survey <- gsub("Oct-2018", "Nov-2018", Warden$Survey) #lump survey dates that straddle Oct/Nov 2018 and call them Nov-2018
  yq <- as.yearqtr(as.yearmon(Warden$Date, "%Y/%m/%d")) #create a temporary season field
Warden$Season <- factor(format(yq, "%q"), levels = 1:4, labels = c("summer", "autumn", "winter", "spring")) #create Season (spring vs summer) variable
  Warden.sum <- Warden[Warden$Season == "summer", ] #summer only data
  Warden.spr <- Warden[Warden$Season == "spring", ] #spring only data
```

####Create a matrix for checking counts - this not used in analysis
```{r create-two-way-table}
Warden_matrix <- acast(Warden, CommonName~Survey, value.var="Count", fun.aggregate = sum) #sums counts for each species and survey
write.csv(Warden_matrix, "./raw_data/Warden_matrix.csv")
```

####Aggregate count data by just common name and survey for creating season matrices
```{r aggregate_count_data_by_Common_name_for_each_season}
Warden.sum.agg <- aggregate(data=Warden.sum, Count ~ CommonName + Survey, FUN="sum") #aggregate count data by species and survey
#Warden.sum.agg$Count <- sqrt(Warden.sum.agg$Count) removed sqrt because metaMDS routine in vegan transforms species abundance data is required.
Warden.spr.agg<- aggregate(data=Warden.spr, Count ~ CommonName + Survey, FUN="sum") #aggregate count data by species and survey
#Warden.spr.agg$Count <- sqrt(Warden.spr.agg$Count) removed sqrt because metaMDS routine in vegan transforms species abundance data is required.
```

####Create waterbird matrices by season
```{r convert-Warden-only-data-to-seasonal-matrices}
#summer
Warden.sum.m <- melt(Warden.sum.agg)
Warden.sum.m <- dcast(Warden.sum.m, Survey ~ CommonName, fill="0")
rownames(Warden.sum.m) <- Warden.sum.m[,1]
Warden.sum.m[,1] <- NULL
write.csv(Warden.sum.m, "Warden_sum_m.csv")
Warden.sum.m <- read.csv("Warden_sum_m.csv", row.names=1)
#spring
Warden.spr.m <- melt(Warden.spr.agg)
Warden.spr.m <- dcast(Warden.spr.m, Survey ~ CommonName, fill="0")
rownames(Warden.spr.m) <- Warden.spr.m[,1]
Warden.spr.m[,1] <- NULL
write.csv(Warden.spr.m, "./analysis_data/Warden_spr_m.csv")
Warden.spr.m <- read.csv("./analysis_data/Warden_spr_m.csv", row.names=1)
```

####MDS unconstrained ordination using metaMDS in package vegan to analyse effects of season within the Warden system
```{r 2D-ordinations-Warden-only}
Warden.sum.MDS <- metaMDS(Warden.sum.m, distance = "bray", autotransform = TRUE)
Warden.spr.MDS <- metaMDS(Warden.spr.m, distance = "bray", autotransform = TRUE)
```

####Extract ordination point data for ggplots
```{r extract-Warden-coords-for-plot}
Warden.sum.MDS.pts <- as.data.frame(Warden.sum.MDS$points) #extract coordinates from ordination
Warden.sum.MDS.pts$Survey <- row.names(Warden.sum.MDS.pts)
Warden.spr.MDS.pts <- as.data.frame(Warden.spr.MDS$points) #extract coordinates from ordination
Warden.spr.MDS.pts$Survey <- row.names(Warden.spr.MDS.pts)
#W.points$season <- c("spring","summer","summer","summer","summer","summer","summer","summer","spring","spring","spring","spring","spring","spring","spring","spring") # add season labels as new column in dataframe
```

####Load environmental data, extract pipeline operation days and create seasonal env matrices (for pipeline days only and for depth and other data)
```{r-load-env-data-split-by-season}
av.depths <- read.csv("./raw_data/average depths.csv") #load data file with average depths (per survey) for gauged Warden wetlands plus other env data
row.names(av.depths) <- av.depths$Survey
av.depths <- av.depths[order(av.depths$Season, av.depths$Survey), ] #order alphabetically by season then survey
Surv.spr <- av.depths[av.depths$Season == "Spring", "Days", drop=FALSE]
Surv.sum <- av.depths[av.depths$Season == "Summer", "Days", drop=FALSE]
Surv.Pipe.spr <- av.depths[av.depths$Season == "Spring", c("Pipeline_days","Days"), drop=FALSE]
Surv.Pipe.sum <- av.depths[av.depths$Season == "Summer", c("Pipeline_days","Days"), drop=FALSE]
Pipeline.spr <- av.depths[av.depths$Season == "Spring", "Pipeline_days", drop=FALSE]
Pipeline.sum <- av.depths[av.depths$Season == "Summer", "Pipeline_days", drop=FALSE]
av.depths$Pipeline_days <- NULL #remove pipeline data from av.depths
av.depths$Days<-NULL
av.depths$Month <- NULL
BEdat.spr <- av.depths[av.depths$Season == "Spring", 3:ncol(av.depths)] #restrict av.depths to spring
row.names(BEdat.spr) <- row.names(av.depths[av.depths$Season == "Spring", ])
BEdat.spr2 <- BEdat.spr #copy env data for spring
BEdat.spr2$Pipeline_days <- Pipeline.spr$Pipeline_days #add spring pipeline data 
BEdat.sum <- av.depths[av.depths$Season == "Summer", 3:ncol(av.depths)] #restrict av.depths to summer
row.names(BEdat.sum) <- row.names(av.depths[av.depths$Season == "Summer", ])
BEdat.sum2 <- BEdat.sum #copy env data for spring
BEdat.sum2$Pipeline_days <- Pipeline.sum$Pipeline_days #add spring pipeline data 

```

####Produce environmental data correlation matrices
```{r check-correlation-between-env-variables}
cor(BEdat.spr, method="pearson")
cor(BEdat.sum, method="pearson")
```

####Range standardise env data
```{r range-standardise-env-data}
BEdat.spr.st <-BEdat.spr
for (i in 1:ncol(BEdat.spr)){
  BEdat.spr.st[, i] <- rescale(BEdat.spr[, i], to = c(0,1))
}
Pipeline.spr$Pipeline_days_st <- rescale(Pipeline.spr$Pipeline_days, to = c(0,1))
BEdat.sum.st <-BEdat.sum
for (i in 1:ncol(BEdat.sum)){
  BEdat.sum.st[, i] <- rescale(BEdat.sum[, i], to = c(0,1))
}
Pipeline.sum$Pipeline_days_st <- rescale(Pipeline.sum$Pipeline_days, to = c(0,1))
```

####Ordination graphs of Warden system waterbird communities by survey with surveys undertaken in spring and summer scaled and coloured by average depth of gauged wetlands  
```{r summer-Warden-ord-plot-bydepths, include=TRUE}
#summer
ggplot(Warden.sum.MDS.pts, aes(x=MDS1, y=MDS2)) + xlim(-0.7, 0.7) + ylim(-0.7, 0.7) + coord_fixed(ratio = 1) + geom_point(aes(size = BEdat.sum.st$Depth, colour=BEdat.sum.st$Depth)) + scale_size(range = c(3, 12)) + geom_text(aes(label = Survey), cex=3, vjust=2, hjust=1.25) + theme(legend.position = "none")
#spring
ggplot(Warden.spr.MDS.pts, aes(x=MDS1, y=MDS2)) + xlim(-0.3, 0.3) + ylim(-0.3, 0.3) + coord_fixed(ratio = 1) + geom_point(aes(size = Warden.spr.m$Australian.Shelduck, colour = Warden.spr.m$Australian.Shelduck)) + scale_size(range = c(3, 12)) + geom_text(aes(label = Survey), cex=3, vjust=2, hjust=1.25) + theme(legend.position = "none") + scale_x_reverse(limits=c(0.3, -0.3))
```

####Create euclidean distance matrices for datasets to be used to partial bioenv analysis
```{r create-matrices-for-Pipeline}
Pipeline.spr.m <-vegdist(Pipeline.spr, method="euclidean")
Pipeline.sum.m <- vegdist(Pipeline.sum, method ="euclidean")
Surv.spr.m <- vegdist(Surv.Pipe.spr$Days, method="euclidean")
Surv.sum.m <- vegdist(Surv.Pipe.sum$Days, method="euclidean")
Surv.Pipe.spr.m <- vegdist(Surv.Pipe.spr, method="euclidean")
Surv.Pipe.sum.m <- vegdist(Surv.Pipe.sum, method="euclidean")
```

####Bio-env analysis to determine influence of pipeline operation, depth and rainfall on waterbrd communities on the Warden wetlands. Uses pearson correlation because env vars without major outliers and not too far off normal in qqnorm plots.
```{r bio-env-Warden}
#SPRING
Warden.spr.be.P <- bioenv(Warden.spr.m, BEdat.spr2, method = "pearson", index = "bray", metric="euclidean")
Warden.spr.be.P
Warden.spr.md <- vegdist(Warden.spr.m, method = "bray") #calculate Warden spring waterbird bray-curtis dissimilarity index
BEdat.spr.md <-bioenvdist(Warden.spr.be.P, which="best")
mantel(Warden.spr.md, BEdat.spr.md, method="pearson", permutations=999) #mantel test to determine permutational significance

#SUMMER
Warden.sum.be.P <- bioenv(Warden.sum.m, BEdat.sum2, method = "pearson", index = "bray", metric="euclidean")
Warden.sum.be.P
Warden.sum.md <- vegdist(Warden.sum.m, method = "bray") #calculate Warden spring waterbird bray-curtis dissimilarity index
BEdat.sum.md <-bioenvdist(Warden.sum.be.P, which="best")
mantel(Warden.sum.md, BEdat.sum.md, method="pearson", permutations=999) #mantel test to determine permutational significance
```

####Bio-env analysis to determine which species best match patterns in overall community ordination
```{r}
#spring
Warden.spr.msq <- sqrt(Warden.spr.m) #sqrt dataset since bv.step (as opposed to bvstep) does not do this, but needs to be done for consistency.
Warden.spr.bio <- bv.step(Warden.spr.msq, Warden.spr.msq, scale.fix=FALSE, scale.var=FALSE, fix.dist.method = "bray", var.dist.method = "bray", max.rho=0.95, min.delta.rho=0.01, output.best=10, num.restarts = 100)
Warden.spr.bio
#note: warnings are not important, see http://menugget.blogspot.com/2011/06/clarke-and-ainsworths-bioenv-and-bvstep.html
Warden.spr8 <- Warden.spr.m[, spring.species] # create new survey x specie matrix with the 8 species from the bv.step analysis
write.csv(Warden.spr8, "Warden 8 species.csv")
Warden.spr8.m <- vegdist(sqrt(Warden.spr8), method= "bray") #create dissimilarity matrix for just 8 species, for use in mantel tests
Warden.spr.md <- vegdist(sqrt(Warden.spr.m), method = "bray") #calculate Warden spring 
mantel(Warden.spr.md, Warden.spr8.m, method="pearson", permutations=999) #mantel test to determine permutational significance
spring.species <- c("Australian.Shelduck","Banded.Stilt","Grey.Teal","Pacific.Black.Duck","Red.necked.Stint","Silver.Gull","Straw.necked.Ibis")
Warden.sprsp.m <- Warden.spr.msq[, spring.species] #extract just the 8 species for spring with square root abundances (because the ordination being used for the envfit (below) was performed on square root distances



#summer



```

####db-RDA analyses including extended plotting
```{r dbRDA-of-Warden-data}
#spring
mod1 <- capscale(Warden.spr.m ~ xxxxxxxx, BEdat.spr, dist="bray") #test individual variables (use BEdat.spr2 to include Pipeline_days
mod1
anova(mod1) #signif of individual variable
#stepwise model procedure without 'pipeline' data
mod2 <- capscale(Warden.spr.m ~ ., BEdat.spr2, dist="bray") #full model
mod0 <- capscale(Warden.spr.m ~ 1, BEdat.spr2, dist="bray") #Null model
ind <- ordistep(mod0, scope = formula(mod2), perm.max = 999) #stepwise model build from all
anova(ind) #signif of stepwise model
mod3 <- capscale(Warden.spr.m ~ CDM12MO_ESPER + CDM12MO_EAERO + Depth, BEdat.spr, dist ="bray") #model selected by ordistep
mod3 #stepwise model
anova(mod3) #signif or stepwise model
#build db-RDA plot from components
plot(mod3, type = "n", choices = c(1, 2))
points(mod3, display = "sites", pch=21, bg = "grey", cex=Warden.sprsp.m$Straw.necked.Ibis^2/50) #scale sites by abundances of the 8 species
text(mod3, display = "sites", cex = 0.7)
points(mod3, display = "bp", cex=2)
text(mod3, display = "bp", cex=0.7, col="blue")


#summer
mod1 <- capscale(Warden.sum.m ~ Depth, BEdat.sum, dist="bray") #test individual variables
anova(mod1) #signif of individual variable
mod2 <- capscale(Warden.sum.m ~ ., BEdat.sum, dist="bray") #full model
mod0 <- capscale(Warden.sum.m ~ 1, BEdat.sum, dist="bray") #Null model
ind <- ordistep(mod0, scope = formula(mod2), perm.max = 999) #stepwise model build from all
anova(ind) #signif of stepwise model
mod3 <- capscale(Warden.sum.m ~ CDM6MO_MYRUP, BEdat.sum, dist ="bray")
mod3
```

#### test whether pipeline is still a factor when Lake Warden data removed
Create a Warden matrix without Lake Warden data
```{r}
Warden.spr.NoWa <- Warden.spr[-grep("WRP013", Warden.spr$SiteCode), ] #remove records for Lake Warden
Warden.spr.NoWa.agg<- aggregate(data=Warden.spr.NoWa, Count ~ CommonName + Survey, FUN="sum")
Warden.spr.NoWa.m <- melt(Warden.spr.NoWa.agg)
Warden.spr.NoWa.m <- dcast(Warden.spr.NoWa.m, Survey ~ CommonName, fill="0")
rownames(Warden.spr.NoWa.m) <- Warden.spr.NoWa.m[,1]
Warden.spr.NoWa.m[,1] <- NULL
write.csv(Warden.spr.NoWa.m, "./analysis_data/Warden_spr_NoWa_m.csv")
Warden.spr.NoWa.m <- read.csv("./analysis_data/Warden_spr_NoWa_m.csv", row.names=1)
```

####Create a warden matrix of just Lake Warden
```{r}
Warden.spr.Wa <- Warden.spr[Warden.spr$SiteCode == "WRP013", ] #include only records for Lake Warden
Warden.spr.Wa.agg<- aggregate(data=Warden.spr.Wa, Count ~ CommonName + Survey, FUN="sum")
Warden.spr.Wa.m <- melt(Warden.spr.Wa.agg)
Warden.spr.Wa.m <- dcast(Warden.spr.Wa.m, Survey ~ CommonName, fill="0")
rownames(Warden.spr.Wa.m) <- Warden.spr.Wa.m[,1]
Warden.spr.Wa.m[,1] <- NULL
write.csv(Warden.spr.Wa.m, "./analysis_data/Warden_spr_NoWa_m.csv")
Warden.spr.Wa.m <- read.csv("./analysis_data/Warden_spr_NoWa_m.csv", row.names=1)
Warden.spr.Wa.md <- vegdist(Warden.spr.Wa.m, method = "bray")
write.csv(as.matrix(Warden.spr.Wa.md), file = "Warden_spr_Wa_md.csv")
```

#####Bioenv without Lake Warden
```{r bioenv-n-Lake-Warden-data}
Warden.spr.NoWa.be <- bioenv(Warden.spr.NoWa.m, Pipeline.spr, method = "pearson", index = "bray", metric="euclidean")
Warden.spr.NoWa.be
Warden.spr.NoWa.md <- vegdist(Warden.spr.NoWa.m, method = "bray") #calculate Warden spring waterbird bray-curtis dissimilarity index
Pipeline.NoWa.be.m <-bioenvdist(Warden.spr.NoWa.be, which="best")
mantel(Warden.spr.NoWa.md, Pipeline.NoWa.be.m, method="pearson", permutations=999) #mantel test to determine permutational significance
```

#####db-RDA without lake Warden
```{r}
mod2 <- capscale(Warden.spr.NoWa.m ~ ., BEdat.spr2, dist="bray") #full model
mod0 <- capscale(Warden.spr.NoWa.m ~ 1, BEdat.spr2, dist="bray") #Null model
ind <- ordistep(mod0, scope = formula(mod2), perm.max = 999) #stepwise model build from all
anova(ind) #signif of stepwise model
mod3 <- capscale(Warden.spr.NoWa.m ~ Pipeline_days, BEdat.spr2, dist ="bray") #model selected by ordistep
anova(mod3) #signif or stepwise model
mod3 #stepwise model
```

####create env dataset with just those vars from the rda and bio-env analyses
```{r}

env.restricted.spr <- c("CDM12MO_ESPER", "CDM12MO_EAERO", "Depth", "Pipeline_days")
BEdat.spr.rest <- BEdat.spr2[, env.restricted.spr]
```

####env fit to add waterbird and environemntal vectors to unconstrained ordination
```{r add-8-species-to-spring-ordination-as-vectors}
#uses Warden.sprsp (from the bio-bio bv.step analysis above) and BEdat.spr.rest (from code above)
fit.spr.birds <- envfit(Warden.spr.MDS, Warden.sprsp.m, permutations = 999, choices=c(1,2)) #fit these species as vectors in unconstrained ordination
Warden.arrows.spr.birds <-as.data.frame(fit.spr.birds$vectors$arrows*sqrt(fit$vectors$r)) #extract vector coordinates
Warden.arrows.spr.birds$Species <- row.names(Warden.arrows.spr.birds) #add species names to vectors
#restricted env vars envfit
fit.spr.birds <- envfit(Warden.spr.MDS, Warden.sprsp.m, permutations = 999, choices=c(1,2)) #fit these species as vectors in unconstrained ordination
fit.spr.env <- envfit(Warden.spr.MDS, BEdat.spr.rest, permutations = 999, choices=c(1,2))
plot(Warden.spr.MDS, display="sites", type = "t")
plot(fit.spr.env)






ggplot(Warden.spr.MDS.pts, aes(x=MDS1, y=MDS2)) + xlim(-0.8, 0.6) + ylim(-0.6, 0.6) + coord_fixed(ratio = 1) + geom_point(aes(size = 2)) + geom_text(aes(label = Survey), colour="blue", cex=3, vjust=2, hjust=1.25) + theme(legend.position = "none") + scale_x_reverse(limits=c(0.6, -0.8)) + geom_segment(data=Warden.arrows.spr,aes(x=0,xend=NMDS1,y=0,yend=NMDS2), arrow = arrow(length = unit(0.5, "cm")),colour="grey",inherit_aes=FALSE) + geom_text(data=Warden.arrows.spr,aes(x=NMDS1,y=NMDS2,label=Species),size=3)

#see https://stackoverflow.com/questions/14711470/plotting-envfit-vectors-vegan-package-in-ggplot2 for adding vectors to ggplot ordination
```







###Stacked column plots for Warden system waterbirds

```{r input_data_and_prepare_for_just_Warden_stacked_column_graphs}
input.data3 <- read.csv("./raw_data/Warden_Gore_by_suite_06_19.csv")
Warden.stack <- input.data3
Warden.stack <- Warden.stack[Warden.stack$System=="Warden", ] #cut down to just Warden.stack wetlands
Warden.stack <- Warden.stack[-grep("Grassbird", Warden.stack$CommonName), ] #remove records of little grassbird
  Warden.stack <- Warden.stack[!(Warden.stack$Date == "23/02/2010" & Warden.stack$SiteCode == "WRP004"), ] #remove duplicate data for Mullet Feb 2010
  Warden.stack$Date <- as.Date(Warden.stack$Date, format="%d/%m/%Y")
  Warden.stack$Survey <- Warden.stack$Date #create Survey field from Date
  Warden.stack$Survey <- format(as.Date(Warden.stack$Survey), "%b-%Y") #change format to mmm-YYYY
  Warden.stack$Survey <- gsub("Oct-2018", "Nov-2018", Warden.stack$Survey) #lump survey dates that straddle Oct/Nov 2018 and call them Nov-2018
  yq <- as.yearqtr(as.yearmon(Warden.stack$Date, "%Y/%m/%d")) #create a temporary season field
Warden.stack$Season <- factor(format(yq, "%q"), levels = 1:4, labels = c("summer", "autumn", "winter", "spring"))
Warden.stack$SurvOrd <- as.character(Warden.stack$Survey)
Warden.stack$SurvOrd <- as.numeric(str_replace_all(Warden.stack$SurvOrd, c("Feb-2008" = "1", "Feb-2010" = "2", "Feb-2011" = "3","Feb-2012" = "4", "Feb-2013" = "5", "Feb-2014" = "6", "Feb-2015" = "7", "Feb-2019" = "8", "Oct-2006" = "1", "Oct-2007" = "2", "Nov-2008" = "3", "Nov-2009" = "4", "Nov-2010" = "5", "Dec-2011" = "6", "Oct-2012" = "7", "Nov-2013"= "8", "Nov-2014" = "9", "Nov-2018" = "10")))
```

```{r import-taxonomy-data-and-add-Group-to-Warden-data}
Taxonomy <- read.csv("./raw_data/Taxonomy.csv")
Warden.stack$Group <- Taxonomy[match(Warden.stack$CommonName, Taxonomy$CommonName), 3]
```

```{r}
Warden.stack.agg <- aggregate(data=Warden.stack, Count ~ Group + SurvOrd + Survey + Season, FUN="sum") #aggregate count data by species and survey
```

```{r plot-spring-survey-abundances}
Warden.stack.spr <- Warden.stack.agg[Warden.stack.agg$Season=="spring", ] #cut down to just spring data
ggplot(Warden.stack.spr, aes(x=reorder(Survey, SurvOrd), y=Count, fill=Group)) + geom_bar(stat="identity", colour = "black") + scale_y_continuous(breaks = seq(0,30000, by=5000), limits=c(0,30000)) + labs(x="Survey", y="Abundance") + theme (axis.text.x=element_text(angle=90)) + theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) + theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))) + scale_fill_manual(values = c("#CD9B9B","#912CEE","#104E8B","#698B22","#00EEEE","#A2B5CD","#FFA500","#FFE1FF","#B4CDCD","#C1FFc1","#A52A2A")) #uses Date to reorder survey on x axis
```

```{r plot-summer-survey-abundances}
Warden.stack.sum <- Warden.stack.agg[Warden.stack.agg$Season=="summer", ] #cut down to just summer data
ggplot(Warden.stack.sum, aes(x=reorder(Survey, SurvOrd), y=Count, fill=Group)) + geom_bar(stat="identity", colour = "black") + scale_y_continuous(breaks = seq(0,30000, by=5000), limits=c(0,30000)) + labs(x="Survey", y="Abundance") + theme (axis.text.x=element_text(angle=90)) + theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) + theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))) + scale_fill_manual(values = c("#CD9B9B","#912CEE","#104E8B","#698B22","#00EEEE","#A2B5CD","#FFA500","#FFE1FF","#B4CDCD","#C1FFc1","#A52A2A")) #uses Date to reorder survey on x axis
```

### Esperance rainfall for Warden wetlands

```{r load-and-prepare-rainfall-data}
rainfall <- read.csv("./raw_data/multi station CDM.csv")
rainfall$Month <- as.yearmon(rainfall$Month, "%b-%y")
rainfall$Month.2 <- rainfall$Month
rainfall$Month.2 <- as.Date(rainfall$Month)
databreaks <- seq(as.Date("2004-01-01"), as.Date("2019-03-01"), by="3 month")
labels <- as.yearmon(databreaks, "%b-%y")
labels
```

```{r plot-of-rainfall-data}
ggplot(rainfall, aes(x = Month.2, y = CDMM, colour=Station)) + geom_line() + theme (axis.text.x=element_text(angle=90)) + scale_x_date(breaks=databreaks, labels = labels)
```

###calculate total abundances per survey
```{r calculate spring total waterbird-abundances}
Warden.spr$year <- lubridate::year(Warden.spr$Date)
Warden.spr.yearsums <- aggregate(data=Warden.spr, Count ~ year + year, FUN="sum")
write.csv(Warden.spr.yearsums, "./analysis_data/warden_spr_yearsums.csv")
```

```{r calculate summer total waterbird-abundances}
Warden.sum$year <- lubridate::year(Warden.sum$Date)
Warden.sum.yearsums <- aggregate(data=Warden.sum, Count ~ year + year, FUN="sum")
write.csv(Warden.sum.yearsums, "./analysis_data/warden_sum_yearsums.csv")
```